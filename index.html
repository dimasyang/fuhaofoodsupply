<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>客戶名單＋成交統計（修正版：成員管理修復＋清空工具）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background-color:#0b1220; color:#e5e7eb; padding-bottom: env(safe-area-inset-bottom); }
    header.sticky, footer.fixed { background: rgba(2,6,23,.92) !important; border-color:#334155 !important; }
    .border, .border-slate-200, .border-slate-300 { border-color:#334155 !important; }
    .bg-white { background-color:#0f172a !important; color:#e5e7eb !important; }
    .bg-slate-50 { background-color:#0f172a !important; }
    .text-slate-900 { color:#e5e7eb !important; }
    .text-slate-600 { color:#cbd5e1 !important; }
    .text-slate-500 { color:#94a3b8 !important; }
    th, thead th { background:#0f172a !important; color:#e5e7eb !important; }
    table, th, td { border-color:#334155 !important; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #334155; padding: 8px 10px; font-size: 14px; }
    .tab-btn-active { background:#0b1220 !important; color:#fff !important; }
    .rounded-2xl.border.bg-white { background-color:#0f172a !important; border-color:#334155 !important; }
    .hint { font-size:12px; color:#94a3b8 }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 9999px; border: 1px solid #475569; color: #e5e7eb; }
    .btn-row { padding: 6px 10px; border-radius: 0.5rem; font-size: 12px; line-height: 1; }
    .btn-row-del { background: #b91c1c; color: #fff; }
    .btn-row-edit { background-color:transparent; color:#e5e7eb; border:1px solid #475569; }
    .btn-row-add { background: #10b981; color: #052e1a; }
    .alert { display:none; }
    .alert.show { display:block; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .modal { display:none; }
    .modal.show { display:flex; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100">
  <div id="alertBar" class="alert bg-rose-900/50 text-rose-100 text-sm px-4 py-2">
    連線或資料庫發生問題；頁面可瀏覽，但讀寫功能暫不可用。
  </div>

  <div class="max-w-6xl mx-auto min-h-screen flex flex-col">
    <header class="sticky top-0 bg-white/90 backdrop-blur border-b border-slate-200 z-40">
      <div class="px-4 py-3 flex items-center justify-between">
        <h1 class="text-lg font-semibold">客戶名單＋成交統計（管理工具版）</h1>
        <div class="flex flex-wrap items-center gap-2">
          <button id="btnUpgrade" class="text-sm px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:opacity-90 active:scale-95">一鍵升級索引欄位</button>
          <button id="btnExportClients" class="text-sm px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100 active:scale-95">匯出客戶CSV</button>
          <button id="btnExportDeals" class="text-sm px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100 active:scale-95">匯出成交CSV</button>
          <span class="hidden md:inline-block w-px h-6 bg-slate-200 mx-1"></span>
          <span class="text-slate-500 text-sm">總成交額：</span>
          <span id="grandTotal" class="text-sm font-semibold tabular-nums">$0</span>
        </div>
      </div>
      <nav class="px-2 pb-2 grid grid-cols-4 gap-2 max-w-6xl mx-auto">
        <button data-tab="add" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium tab-btn-active">新增/編輯</button>
        <button data-tab="list" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium bg-white border border-slate-200">名單查詢</button>
        <button data-tab="members" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium bg-white border border-slate-200">成員管理</button>
        <button data-tab="tools" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium bg-white border border-slate-200">工具</button>
      </nav>
    </header>

    <main class="flex-1 px-4 pb-24">
      <!-- ADD / EDIT CLIENT -->
      <section id="tab-add" class="tab mt-4">
        <form id="clientForm" class="space-y-3 max-w-3xl">
          <input type="hidden" id="clientId" />
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">廠商名稱 <span class="text-red-600">*</span></label>
              <input id="name" class="w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 bg-white" placeholder="例：幸福海鮮餐廳" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">行業類型</label>
              <input id="industry" class="w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 bg-white" placeholder="例：餐廳、零售" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="block text-sm font-medium">誰的客戶（來源成員）</label>
                <span id="ownerHint" class="hint"></span>
              </div>
              <select id="owner" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">拜訪狀態</label>
              <select id="status" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white">
                <option value="未拜訪">未拜訪</option>
                <option value="已聯繫">已聯繫</option>
                <option value="已拜訪">已拜訪</option>
                <option value="追蹤中">追蹤中</option>
                <option value="成交">成交</option>
                <option value="冷卻">冷卻</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">可以推薦的產品（逗號分隔）</label>
              <input id="recommended" class="w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 bg-white" placeholder="例：烏魚子米蛋捲, 鮭魚鬆米蛋捲" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">下次跟進日</label>
              <input id="nextFollow" type="date" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">備註</label>
            <textarea id="discussion" rows="3" class="w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 bg-white" placeholder="例如：建議先送試吃、搭配禮盒…"></textarea>
          </div>

          <div class="flex items-center gap-2 pt-2">
            <button id="btnSave" class="flex-1 px-4 py-3 rounded-2xl bg-blue-600 text-white font-medium active:scale-95">儲存</button>
            <button type="button" id="btnReset" class="px-4 py-3 rounded-2xl border border-slate-300 bg-white active:scale-95">清空</button>
            <button type="button" id="btnDelete" class="hidden px-5 py-3 rounded-2xl bg-rose-600 text-white active:scale-95">刪除</button>
          </div>
          <p class="text-xs text-slate-500">（系統會自動建立快速查詢欄位：nameLC、ownerLC）</p>
        </form>

        <!-- Deals panel in Add/Edit -->
        <div id="dealPanel" class="mt-6 rounded-2xl border border-slate-200 bg-white p-3 space-y-3 max-w-3xl hidden">
          <div class="flex items-center justify-between">
            <div class="font-medium">成交紀錄（可連續新增，多次成交會自動累積）</div>
            <div class="text-sm text-slate-500">累計金額：<span id="dealTotal" class="font-semibold text-slate-900">0</span></div>
          </div>
          <form id="dealForm" class="grid grid-cols-1 md:grid-cols-6 gap-2">
            <input id="dealDate" type="date" class="md:col-span-2 px-3 py-2 rounded-xl border border-slate-300 bg-white" />
            <input id="dealAmount" type="number" step="1" min="0" class="md:col-span-2 px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="金額（必填）" required />
            <input id="dealNote" class="md:col-span-2 px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="備註（選填）" />
            <button id="btnAddDealInline" type="submit" class="md:col-span-6 px-4 py-2 rounded-xl bg-emerald-600 text-white">＋ 新增成交</button>
          </form>
          <div class="overflow-x-auto">
            <table>
              <thead>
                <tr>
                  <th style="width:20%">日期</th>
                  <th style="width:20%">金額</th>
                  <th style="width:44%">備註</th>
                  <th style="width:16%">操作</th>
                </tr>
              </thead>
              <tbody id="dealTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- 快速導入區塊 -->
        <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-3 space-y-3 max-w-3xl">
          <div class="flex items-center justify-between">
            <div class="font-medium">快速導入客戶（貼上文字）</div>
            <button id="btnShowFormat" class="text-xs underline">格式說明</button>
          </div>
          <textarea id="pasteInput" rows="8" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white mono" placeholder="每行一筆，欄位順序：名稱, 行業, 來源成員, 推薦產品
支援分隔：逗號(,)、中文逗號(，)、分號(;)、Tab"></textarea>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <button id="btnPreviewPaste" class="px-3 py-2 rounded-xl border border-slate-300 bg-white active:scale-95 w-full">預覽解析（不寫入）</button>
            <button id="btnImportPaste" class="px-3 py-2 rounded-xl bg-slate-900 text-white active:scale-95 w-full">一鍵建檔</button>
            <button id="btnTestWrite" class="px-3 py-2 rounded-xl bg-emerald-600 text-white active:scale-95 w-full">測試寫入權限</button>
          </div>
          <div id="previewPanel" class="hidden bg-slate-50 border border-slate-200 rounded-xl p-2 text-xs whitespace-pre-wrap mono"></div>
          <div id="importResult" class="hidden bg-slate-50 border border-slate-200 rounded-xl p-2 text-xs whitespace-pre-wrap mono"></div>
          <div class="hint">提示：若尚未建立成員，來源成員會自動記為「未指定」。</div>
        </div>
      </section>

      <!-- LIST / QUERY (TABLE) -->
      <section id="tab-list" class="tab hidden mt-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-3">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
            <input id="q" class="px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="輸入『廠商名稱』或『誰的客戶』查詢（留空＝查全部）" />
            <select id="filterOwner" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">
              <option value="">誰的客戶（全部）</option>
            </select>
            <div class="md:col-span-3"></div>
          </div>
          <div class="flex items-center gap-2 mt-3">
            <button id="btnQuery" class="px-3 py-2 rounded-xl bg-slate-900 text-white active:scale-95">查詢</button>
            <button id="btnShowAll" class="px-3 py-2 rounded-xl border border-slate-300 bg-white active:scale-95">顯示全部</button>
            <button id="btnLoadMore" class="ml-auto px-3 py-2 rounded-xl border border-slate-300 bg-white active:scale-95">載入更多</button>
          </div>
          <div class="mt-2 text-sm text-slate-600">本次查詢成交額合計：$<span id="listTotal" class="tabular-nums font-semibold">0</span></div>
          <div class="overflow-x-auto mt-3">
            <table>
              <thead>
                <tr>
                  <th style="width:22%">廠商名稱</th>
                  <th style="width:14%">行業類型</th>
                  <th style="width:14%">誰的客戶</th>
                  <th style="width:18%">可推薦產品</th>
                  <th style="width:12%">狀態</th>
                  <th style="width:12%">累計成交額</th>
                  <th style="width:8%">操作</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
            <div id="emptyList" class="hidden text-sm text-slate-500 p-3">目前尚無客戶，請先到「新增/編輯」建立。</div>
          </div>
          <div id="upgradeStatus" class="text-xs text-slate-500 mt-2"></div>
          <p class="text-xs text-slate-500 mt-2">提示：關鍵字同時比對「廠商名稱（前綴）」與「誰的客戶（全名）」。</p>
        </div>
      </section>

      <!-- MEMBERS -->
      <section id="tab-members" class="tab hidden mt-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-3 space-y-4">
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            <input id="memberName" class="px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="成員名稱（必填）」 />
            <input id="memberIndustry" class="px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="行業別（例：水產批發零售）" />
            <button id="btnAddMember" class="px-3 py-2 rounded-xl bg-emerald-600 text-white active:scale-95">新增成員</button>
          </div>

          <div class="grid gap-2 md:grid-cols-2">
            <div>
              <label class="text-sm font-medium">CSV 匯入（欄位：姓名, 行業別）</label>
              <input id="memberCsv" type="file" accept=".csv,text/csv" class="block w-full text-sm" />
              <button id="btnImportCsv" class="mt-2 px-3 py-2 rounded-xl border border-slate-300 bg-white active:scale-95 w-full">匯入 CSV 成員</button>
              <div class="hint mt-1">支援 UTF-8/Big5 偵測。</div>
            </div>
            <div>
              <label class="text-sm font-medium">快速貼上（每行：姓名, 行業別；僅姓名也可）</label>
              <textarea id="memberBulk" rows="4" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="例：
南笛, 水產批發零售
舜瑋, 魚漿煉製品批發代工
聖閔, 牛肉批發零售
宜芳, 沖泡式飲品品牌電商"></textarea>
              <button id="btnBulkAdd" class="mt-2 px-3 py-2 rounded-xl border border-slate-300 bg-white active:scale-95 w-full">從貼上清單新增</button>
            </div>
          </div>

          <div id="memberEmpty" class="hint">目前沒有任何成員，先用上方欄位新增幾位吧！</div>
          <ul id="memberList" class="mt-1 divide-y divide-slate-200"></ul>
        </div>
      </section>

      <!-- TOOLS -->
      <section id="tab-tools" class="tab hidden mt-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-3 space-y-3">
          <div class="font-medium">管理工具（危險操作，請小心）</div>
          <button id="btnWipeClients" class="px-3 py-2 rounded-xl bg-rose-700 text-white active:scale-95 w-full">⚠️ 清空所有「客戶＋成交」</button>
          <button id="btnWipeMembers" class="px-3 py-2 rounded-xl bg-rose-700 text-white active:scale-95 w-full">⚠️ 清空所有「成員」</button>
          <div id="wipeLog" class="mono text-xs bg-slate-50 border border-slate-200 rounded-xl p-2 whitespace-pre-wrap"></div>
          <p class="hint">需要輸入「DELETE」確認；操作不可復原，務必先匯出備份。</p>
        </div>
      </section>
    </main>

    <footer class="fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t border-slate-200 p-3">
      <div class="max-w-6xl mx-auto grid grid-cols-2 gap-2">
        <button class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-medium active:scale-95" data-tab="add">＋ 新增客戶</button>
        <button class="px-4 py-3 rounded-2xl border border-slate-300 bg-white active:scale-95" data-tab="list">名單查詢</button>
      </div>
    </footer>
  </div>

  <!-- Modal for quick add deal -->
  <div id="dealModal" class="modal fixed inset-0 bg-black/40 items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-4 w-[92vw] max-w-md">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">新增成交</div>
        <button id="dealModalClose" class="px-2 py-1 text-slate-500">✕</button>
      </div>
      <div class="text-sm text-slate-500 mb-3">客戶：<span id="dealModalName" class="font-medium text-slate-900"></span></div>
      <div class="space-y-2">
        <input id="dealModalDate" type="date" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" />
        <input id="dealModalAmount" type="number" min="0" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="金額（必填）" />
        <input id="dealModalNote" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" placeholder="備註（選填）" />
        <button id="dealModalSubmit" class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white">送出</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  // ====== Tab Switch ======
  (function ensureTabs(){
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    window._switchTab = function(tab){
      $$('.tab-btn').forEach(b=>{
        b.classList.toggle('tab-btn-active', b.dataset.tab===tab);
        b.classList.toggle('bg-white', b.dataset.tab!==tab);
        b.classList.toggle('border', b.dataset.tab!==tab);
        b.classList.toggle('border-slate-200', b.dataset.tab!==tab);
      });
      $$('.tab').forEach(sec=>sec.classList.toggle('hidden', sec.id!=='tab-'+tab));
    };
    document.addEventListener('click', function(e){
      const t = e.target.closest('[data-tab]');
      if(!t) return;
      e.preventDefault();
      window._switchTab(t.dataset.tab);
    });
  })();

  // ====== Main ======
  (async function main(){
    try{
      const cfg = {
        apiKey: "AIzaSyDaafwU3OhsA4lqiGfsMdKhngDN3-aKFBo",
        authDomain: "foodsupply-powerteam-fuhao.firebaseapp.com",
        projectId: "foodsupply-powerteam-fuhao",
        storageBucket: "foodsupply-powerteam-fuhao.firebasestorage.app",
        messagingSenderId: "777142283146",
        appId: "1:777142283146:web:a603947fb1f2b52474f673",
        measurementId: "G-R8E9D9W24Z"
      };
      firebase.initializeApp(cfg);
      const db = firebase.firestore();

      // Utils
      const $ = (s)=>document.querySelector(s);
      const $$ = (s)=>Array.from(document.querySelectorAll(s));
      const STATUSES = ['未拜訪','已聯繫','已拜訪','追蹤中','成交','冷卻'];
      function toast(msg){ const t=document.createElement('div'); t.textContent=msg; t.className='fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-sm px-3 py-2 rounded-xl shadow-lg z-50'; document.body.appendChild(t); setTimeout(()=>t.remove(),2200); }
      const nowTS = ()=> firebase.firestore.FieldValue.serverTimestamp();
      function lc(s){ return (s||'').toString().trim().toLowerCase(); }
      async function getServerFirst(q){ try{ return await q.get({ source: 'server' }); } catch(e){ return await q.get(); } }

      // ===== Members =====
      const ownerSel = $('#owner');
      const ownerHint = $('#ownerHint');
      const filterOwnerSel = $('#filterOwner');
      const memberList = $('#memberList');
      const memberEmpty = $('#memberEmpty');
      let membersCache = [];
      let membersUnsub = null;

      function rebuildOwnerSelect() {
        const had = membersCache.length > 0;
        ownerSel.innerHTML = '';
        if (!had) {
          ownerHint.textContent = '目前尚未建立成員，將自動記錄為「未指定」';
          const opt = document.createElement('option');
          opt.value = ''; opt.textContent = '（未指定）';
          ownerSel.appendChild(opt);
          ownerSel.disabled = true;
        } else {
          ownerHint.textContent = '';
          ownerSel.disabled = false;
          const opt = document.createElement('option');
          opt.value = ''; opt.textContent = '請選擇成員';
          ownerSel.appendChild(opt);
          for (const m of membersCache) {
            const o = document.createElement('option');
            o.value = m.name || '';
            o.textContent = m.industry ? `${m.name}（${m.industry}）` : (m.name || '');
            ownerSel.appendChild(o);
          }
        }
        const cur = filterOwnerSel.value || '';
        filterOwnerSel.innerHTML = '<option value="">誰的客戶（全部）</option>';
        for (const m of membersCache) {
          const o = document.createElement('option');
          o.value = m.name || '';
          o.textContent = m.name || '';
          filterOwnerSel.appendChild(o);
        }
        filterOwnerSel.value = cur;
      }

      function renderMembersList() {
        memberList.innerHTML = '';
        if (membersCache.length === 0) {
          memberEmpty.classList.remove('hidden');
          return;
        }
        memberEmpty.classList.add('hidden');
        membersCache.forEach(m => {
          const li = document.createElement('li');
          li.dataset.id = m.id;
          li.className = 'py-2 flex items-center gap-2';
          li.innerHTML = `
            <span class="flex-1 min-w-0">${m.name||''} ${m.industry? `<span class="badge">${m.industry}</span>`:''}</span>
            <button class="px-2 py-1.5 rounded-lg bg-blue-600 text-white text-xs" data-act="edit">編輯</button>
            <button class="px-2 py-1.5 rounded-lg bg-rose-600 text-white text-xs" data-act="del">刪除</button>`;
          li.querySelector('[data-act="del"]').onclick = async () => {
            if (!confirm(`確定刪除成員「${m.name||''}」？`)) return;
            try { await db.collection('members').doc(m.id).delete(); toast('已刪除成員'); }
            catch(e){ console.error(e); toast('刪除失敗'); }
          };
          li.querySelector('[data-act="edit"]').onclick = async () => {
            const newName = prompt('成員姓名', m.name||''); if(newName===null) return;
            const newInd  = prompt('行業別', m.industry||''); if(newInd===null) return;
            try { await db.collection('members').doc(m.id).update({ name: newName.trim(), industry: (newInd||'').trim(), updatedAt: nowTS() }); toast('已更新成員'); }
            catch(e){ console.error(e); toast('更新失敗'); }
          };
          memberList.appendChild(li);
        });
      }

      async function mountMembersListener(){
        if (membersUnsub) membersUnsub();
        try{ await getServerFirst(db.collection('members').limit(1)); }catch(_){}
        membersUnsub = db.collection('members').orderBy('name').onSnapshot((snap)=>{
          membersCache = [];
          snap.forEach(doc => { membersCache.push({ id: doc.id, ...doc.data() }); });
          rebuildOwnerSelect();
          renderMembersList();
        }, (err)=>{
          console.error('members onSnapshot', err);
          document.getElementById('alertBar').classList.add('show');
        });
      }

      async function addMembers(arr){
        const exist = new Set();
        try {
          const snap = await getServerFirst(db.collection('members').select('name'));
          snap.forEach(d=> exist.add((d.data().name||'').trim()));
        } catch(_) {}
        const toAdd = arr.map(x=>({name:(x.name||'').trim(), industry:(x.industry||'').trim()})).filter(x=>x.name && !exist.has(x.name));
        if(!toAdd.length) return;
        const CHUNK = 400;
        for (let i=0;i<toAdd.length;i+=CHUNK){
          const batch = db.batch();
          toAdd.slice(i,i+CHUNK).forEach(p=> batch.set(db.collection('members').doc(), { ...p, createdAt: nowTS() }));
          await batch.commit();
        }
      }

      // 成員：匯入/貼上/新增
      $('#btnImportCsv').addEventListener('click', async ()=>{
        const f = $('#memberCsv').files?.[0]; if(!f) return toast('請選擇 CSV 檔');
        try{
          const buf = await f.arrayBuffer();
          let text = new TextDecoder('utf-8').decode(buf);
          if ((text.match(/\uFFFD/g)||[]).length > 8) {
            try { text = new TextDecoder('big5').decode(buf); } catch(_){}
          }
          const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
          const arr = rows.map(r=>{ const m=r.split(/,|，/); return { name:(m[0]||'').trim(), industry:(m[1]||'').trim() }; }).filter(x=>x.name);
          await addMembers(arr); toast('已匯入成員');
        }catch(e){ console.error(e); toast('匯入失敗'); }
      });
      $('#btnBulkAdd').addEventListener('click', async ()=>{
        const text = ($('#memberBulk').value||'').trim(); if(!text) return;
        const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        const arr = rows.map(r=>{ const m=r.split(/,|，/); return { name:(m[0]||'').trim(), industry:(m[1]||'').trim() }; }).filter(x=>x.name);
        try{ await addMembers(arr); toast('已新增成員'); $('#memberBulk').value=''; }catch(e){ console.error(e); toast('新增失敗'); }
      });
      $('#btnAddMember').addEventListener('click', async ()=>{
        const name = ($('#memberName').value||'').trim(); if(!name) return toast('請輸入成員名稱');
        const industry = ($('#memberIndustry').value||'').trim();
        try{
          await db.collection('members').add({ name, industry, createdAt: nowTS() });
          $('#memberName').value=''; $('#memberIndustry').value=''; toast('已新增成員');
        }catch(e){ console.error(e); toast('新增失敗'); }
      });

      // ===== Clients =====
      const form=$('#clientForm');
      const btnDelete=$('#btnDelete');
      let editingId=null;
      const tableEl = document.getElementById('tableBody');
      const listTotalEl = document.getElementById('listTotal');
      const emptyList = document.getElementById('emptyList');
      let lastDoc = null;

      function formData(){
        const name = $('#name').value.trim();
        let owner = $('#owner').value || '';
        if (!owner) owner = '未指定';
        return {
          name,
          industry:$('#industry').value.trim(),
          owner,
          status:$('#status').value,
          nextFollow: $('#nextFollow').value? new Date($('#nextFollow').value): null,
          recommended:$('#recommended').value.trim(),
          notes:$('#discussion').value.trim(),
          nameLC: lc(name),
          ownerLC: lc(owner),
          updatedAt: nowTS()
        };
      }

      function fillForm(c){
        $('#clientId').value=c.id||'';
        $('#name').value=c.name||'';
        $('#industry').value=c.industry||'';
        $('#owner').value=c.owner||'';
        $('#status').value=c.status||'未拜訪';
        try{ $('#nextFollow').value= c.nextFollow? new Date((c.nextFollow.seconds? c.nextFollow.seconds*1000 : c.nextFollow)).toISOString().slice(0,10):''; }catch(e){ $('#nextFollow').value=''; }
        $('#recommended').value=c.recommended||'';
        $('#discussion').value=c.notes||'';
        editingId=c.id||null;
        btnDelete.classList.toggle('hidden', !editingId);
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const d=formData();
        if(!d.name) return toast('請輸入廠商名稱');
        try{
          if(editingId){
            await db.collection('clients').doc(editingId).update(d);
            toast('已更新');
          } else {
            const ref = await db.collection('clients').add({ ...d, createdAt: nowTS(), comments: [], totalAmount: 0 });
            editingId = ref.id;
          }
          window._switchTab('list'); await runQuery(true, true); await calcGrandTotal();
        }catch(err){ console.error(err); toast('儲存失敗'); }
      });
      $('#btnReset').addEventListener('click', ()=>{ form.reset(); editingId=null; btnDelete.classList.add('hidden'); });
      btnDelete.addEventListener('click', async (e)=>{
        e.preventDefault();
        if(!editingId) return;
        if(!confirm('確定刪除此客戶？（其成交紀錄也會一併刪除）')) return;
        try{
          const dealsSnap = await db.collection('clients').doc(editingId).collection('deals').get();
          const batch = db.batch(); dealsSnap.forEach(d=> batch.delete(d.ref)); batch.delete(db.collection('clients').doc(editingId)); await batch.commit();
          toast('已刪除'); form.reset(); editingId=null; btnDelete.classList.add('hidden'); window._switchTab('list'); await runQuery(true, true); await calcGrandTotal();
        }catch(err){ console.error(err); toast('刪除失敗'); }
      });

      function currency(n){ if(n==null||isNaN(n)) return '0'; return Number(n).toLocaleString('zh-TW'); }

      // Import
      function parsePaste(raw){
        if (!raw) return [];
        let text = raw.replace(/\r\n|\r/g,'\n');   // 任何換行→\n
        text = text.replace(/\t/g, ',');          // Tab→逗號
        text = text.replace(/；/g,';');           // 全形分號→半形
        const lines = text.split(/\n+/).map(l=>l.trim()).filter(Boolean);
        const rows = [];
        for (const line of lines){
          let parts = line.split(/,|，|;|\s{2,}/).map(s=>s.trim()).filter(s=>s!=='');
          if (parts.length === 1) { const sp = line.split(/\s+/); if (sp.length >= 2) parts = sp; }
          const name = (parts[0]||'').trim();
          const industry = (parts[1]||'').trim();
          const owner = (parts[2]||'').trim();
          const recommended = (parts.slice(3).join('，')||'').trim();
          if (!name) continue;
          rows.push({ name, industry, owner, recommended });
        }
        return rows;
      }

      function rowTpl(c){
        const el=document.createElement('tr'); el.dataset.id = c.id; const total = Number(c.totalAmount||0);
        el.innerHTML = `
          <td class="font-medium">${c.name||''}</td>
          <td>${c.industry||''}</td>
          <td>${c.owner||''}</td>
          <td>${c.recommended||''}</td>
          <td><select class="status-select px-2 py-1 rounded-lg border border-slate-300 bg-white text-sm">
            ${STATUSES.map(s=>`<option ${s===(c.status||'未拜訪')?'selected':''} value="${s}">${s}</option>`).join('')}
          </select></td>
          <td class="tabular-nums">$${currency(total)}</td>
          <td>
            <div class="flex items-center gap-2">
              <button class="btn-row btn-row-add" data-act="addDeal">＋成交</button>
              <button class="btn-row btn-row-edit" data-act="edit">編輯</button>
              <button class="btn-row btn-row-del" data-act="del">刪除</button>
            </div>
          </td>`;
        el.querySelector('[data-act="edit"]').onclick=()=>{ fillForm({id:c.id,...c}); window._switchTab('add'); };
        el.querySelector('[data-act="del"]').onclick=async()=>{
          if(!confirm(`刪除「${c.name}」？（含成交紀錄）`)) return;
          try{
            const dealsSnap = await db.collection('clients').doc(c.id).collection('deals').get();
            const batch = db.batch(); dealsSnap.forEach(d=> batch.delete(d.ref)); batch.delete(db.collection('clients').doc(c.id)); await batch.commit();
            toast('已刪除'); await runQuery(true, true); await calcGrandTotal();
          }catch(e){ console.error(e); toast('刪除失敗'); }
        };
        const sel = el.querySelector('.status-select');
        sel.addEventListener('change', async () => {
          const oldVal = c.status || '未拜訪'; const newVal = sel.value; if (newVal === oldVal) return;
          sel.disabled = true; sel.style.opacity = '0.6';
          try{ await db.collection('clients').doc(c.id).update({ status: newVal, updatedAt: nowTS() }); c.status = newVal; toast('狀態已更新'); }
          catch(e){ console.error(e); sel.value = oldVal; toast('更新失敗'); }
          finally{ sel.disabled = false; sel.style.opacity = ''; }
        });
        el.querySelector('[data-act="addDeal"]').onclick=()=> openDealModal(c.id, c.name);
        return el;
      }

      function renderPreview(rows){
        const panel = document.getElementById('previewPanel');
        if (!rows || rows.length===0){ panel.classList.add('hidden'); panel.textContent=''; return; }
        const header = '預覽（不寫入）：共 '+rows.length+' 筆\n----------------------------------\n';
        const lines = rows.map((r,i)=>`${i+1}. 名稱=${r.name}｜行業=${r.industry||''}｜來源=${r.owner||'未指定'}｜推薦=${r.recommended||''}`);
        panel.textContent = header + lines.join('\n');
        panel.classList.remove('hidden');
      }

      async function importClients(rows){
        if (!rows || rows.length===0) { toast('沒有可匯入的資料'); return {ok:0,skip:0,fail:0}; }
        const CHUNK = 400;
        let ok=0, skip=0, fail=0;
        const seen = new Set();
        const uniq = [];
        for (const r of rows){
          const key = [r.name.trim(), (r.industry||'').trim(), (r.owner||'未指定').trim()].join('||');
          if (seen.has(key)) { skip++; continue; }
          seen.add(key); uniq.push(r);
        }
        const progress = document.getElementById('importResult'); if (progress) { progress.classList.remove('hidden'); progress.textContent = '開始寫入…'; }
        for (let i=0;i<uniq.length;i+=CHUNK){
          const batch = db.batch();
          const part = uniq.slice(i,i+CHUNK);
          part.forEach(r=>{
            const name = r.name.trim();
            const industry = (r.industry||'').trim();
            const owner = (r.owner||'').trim() || '未指定';
            const recommended = (r.recommended||'').trim();
            const ref = db.collection('clients').doc();
            batch.set(ref, { name, industry, owner, status:'未拜訪', recommended, notes:'', nextFollow:null, nameLC:lc(name), ownerLC:lc(owner), totalAmount:0, comments:[], createdAt:nowTS(), updatedAt:nowTS() });
          });
          try{ await batch.commit(); ok += part.length; }catch(e){ console.error('batch commit failed', e); fail += part.length; }
          if (progress) progress.textContent = `已處理 ${Math.min(i+CHUNK, uniq.length)} / ${uniq.length} 筆…（成功 ${ok}，略過重覆 ${skip}，失敗 ${fail}）`;
        }
        return {ok, skip, fail};
      }

      document.getElementById('btnPreviewPaste').addEventListener('click', ()=>{
        const raw = (document.getElementById('pasteInput').value||'').trim();
        const rows = parsePaste(raw);
        renderPreview(rows);
        if (!rows.length) toast('沒有可解析的資料');
      });

      document.getElementById('btnShowFormat').addEventListener('click', ()=>{
        const demo = [
          '幸福海鮮餐廳, 餐館, 南笛, 烏魚子米蛋捲',
          '阿美小吃；小吃；舜瑋；鮭魚鬆米蛋捲, 海帶脆片',
          '金典超市\t零售\t\t綜合禮盒',
          '海口郎水產  水產零售  南笛  烏魚子鳳梨酥'
        ].join('\n');
        const ta = document.getElementById('pasteInput');
        ta.value = demo;
        toast('已填入範例，可按「預覽解析」');
      });

      document.getElementById('btnImportPaste').addEventListener('click', async ()=>{
        const raw = (document.getElementById('pasteInput').value||'').trim();
        const rows = parsePaste(raw);
        if (!rows.length) { toast('沒有可解析的資料'); return; }
        if (!confirm(`確認匯入 ${rows.length} 筆？`)) return;
        try{
          const {ok, skip, fail} = await importClients(rows);
          toast(`匯入完成：成功 ${ok}，略過 ${skip}，失敗 ${fail}`);
          document.getElementById('pasteInput').value='';
          document.getElementById('previewPanel').classList.add('hidden');
          await runQuery(true, true);
          await calcGrandTotal();
          window._switchTab('list');
        }catch(e){ console.error(e); toast('匯入失敗'); }
      });

      // ===== Deals =====
      const dealTbody = document.getElementById('dealTableBody');
      const dealModal = document.getElementById('dealModal');
      const dealModalClose = document.getElementById('dealModalClose');
      function openDealModal(id, name){
        dealModal.dataset.id = id;
        document.getElementById('dealModalName').textContent = name || '';
        document.getElementById('dealModalDate').value='';
        document.getElementById('dealModalAmount').value='';
        document.getElementById('dealModalNote').value='';
        dealModal.classList.add('show');
      }
      dealModalClose.addEventListener('click', ()=> dealModal.classList.remove('show'));
      document.getElementById('dealModalSubmit').addEventListener('click', async ()=>{
        const id = dealModal.dataset.id; const amt = Number(document.getElementById('dealModalAmount').value||''); if(!(amt>=0)) return toast('請輸入金額');
        const date = document.getElementById('dealModalDate').value || null;
        const note = document.getElementById('dealModalNote').value || '';
        try{ await addDeal(id, amt, date, note); toast('已新增成交'); dealModal.classList.remove('show'); await runQuery(true, true); await calcGrandTotal(); }
        catch(e){ console.error(e); toast('新增失敗'); }
      });

      async function addDeal(clientId, amount, date=null, note=''){
        if(!clientId) throw new Error('missing clientId');
        if(!(amount>=0)) throw new Error('amount required');
        const dealsRef = db.collection('clients').doc(clientId).collection('deals');
        const clientRef = db.collection('clients').doc(clientId);
        const when = date? new Date(date) : new Date();
        const payload = { amount: Number(amount), date: when.getTime(), note: (note||'').trim(), createdAt: nowTS() };
        await db.runTransaction(async (tx)=>{
          const cSnap = await tx.get(clientRef); if(!cSnap.exists) throw new Error('client not found');
          const curTotal = Number(cSnap.data().totalAmount || 0); const newTotal = curTotal + Number(amount);
          const newUpdated = nowTS(); const newStatus = '成交';
          tx.set(dealsRef.doc(), payload); tx.update(clientRef, { totalAmount: newTotal, updatedAt: newUpdated, status: newStatus });
        });
      }

      // ===== Export CSV =====
      function toCSV(rows){
        return rows.map(r=>r.map(v=>{
          const s = (v==null?'':String(v)).replace(/"/g,'""');
          return `"${s}"`;
        }).join(',')).join('\r\n');
      }
      document.getElementById('btnExportClients').addEventListener('click', async ()=>{
        const rows = [['名稱','行業','誰的客戶','狀態','可推薦產品','累計成交額']];
        const snap = await getServerFirst(db.collection('clients').orderBy('nameLC').limit(2000));
        if (snap.empty) { toast('目前沒有客戶資料'); return; }
        snap.forEach(d=>{
          const c = d.data();
          rows.push([c.name||'', c.industry||'', c.owner||'', c.status||'', c.recommended||'', Number(c.totalAmount||0)]);
        });
        const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='clients.csv'; a.click(); URL.revokeObjectURL(url);
      });
      document.getElementById('btnExportDeals').addEventListener('click', async ()=>{
        const rows = [['客戶','日期','金額','備註']];
        const snap = await getServerFirst(db.collection('clients').orderBy('nameLC').limit(200));
        if (snap.empty) { toast('目前沒有成交資料'); return; }
        for (const d of snap.docs){
          const c = { id: d.id, ...d.data() };
          const deals = await db.collection('clients').doc(c.id).collection('deals').orderBy('date','desc').limit(200).get();
          deals.forEach(x=>{
            const dd = x.data();
            rows.push([c.name||'', dd.date? new Date(dd.date).toISOString().slice(0,10):'', Number(dd.amount||0), dd.note||'']);
          });
        }
        const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='deals.csv'; a.click(); URL.revokeObjectURL(url);
      });

      // ===== One-click Upgrade =====
      async function upgradeIndices(){
        if(!confirm('為所有客戶補齊 nameLC / ownerLC / totalAmount 欄位，開始？')) return;
        const statusEl = document.getElementById('upgradeStatus'); let scanned = 0, updated = 0, skipped = 0, batchCount=0; statusEl.textContent = '準備中…';
        try{
          let last = null; let more = true;
          while(more){
            let q = db.collection('clients').orderBy('updatedAt').limit(400);
            if(last) q = q.startAfter(last);
            const snap = await getServerFirst(q);
            more = !snap.empty && snap.docs.length === 400;
            if(!snap.empty) last = snap.docs[snap.docs.length-1];
            if(snap.empty){ break; }
            let batch = db.batch(); let ops = 0;
            for(const doc of snap.docs){
              scanned++; const c = doc.data();
              const wantNameLC = lc(c.name); const wantOwnerLC = lc(c.owner); const patch = {};
              if(c.nameLC !== wantNameLC) patch.nameLC = wantNameLC;
              if(c.ownerLC !== wantOwnerLC) patch.ownerLC = wantOwnerLC;
              if(typeof c.totalAmount !== 'number') patch.totalAmount = 0;
              if(Object.keys(patch).length){ batch.update(doc.ref, patch); ops++; } else { skipped++; }
            }
            if(ops>0){ await batch.commit(); updated += ops; batchCount++; }
            statusEl.textContent = `處理中… 已掃描 ${scanned} 筆，已更新 ${updated} 筆，略過 ${skipped} 筆。`;
          }
          statusEl.textContent = `完成！共掃描 ${scanned} 筆，更新 ${updated} 筆，略過 ${skipped} 筆（批次提交 ${batchCount} 次）。`;
          toast('升級完成'); await runQuery(true, true); await calcGrandTotal();
        }catch(e){ console.error(e); statusEl.textContent = '升級失敗'; }
      }
      document.getElementById('btnUpgrade').addEventListener('click', upgradeIndices);

      // ===== Query =====
      function rowTplList(c){ return rowTpl(c); }
      async function runQuery(reset=false, forceServer=false){
        if(reset){ tableEl.innerHTML=''; listTotalEl.textContent='0'; lastDoc=null; }
        const kw = (document.getElementById('q').value||'').trim().toLowerCase();
        const ownerFilter = (document.getElementById('filterOwner').value||'').trim();
        let q = db.collection('clients');
        const idPath = firebase.firestore.FieldPath.documentId();
        const hasKw = !!kw;
        if(hasKw){
          q = q.where('nameLC', '>=', kw).where('nameLC', '<=', kw + '\uf8ff').orderBy('nameLC');
        } else {
          q = q.orderBy(idPath);
        }
        if(ownerFilter){
          q = q.where('owner', '==', ownerFilter);
        }
        q = q.limit(50);
        if(lastDoc) q = q.startAfter(lastDoc);
        const snap = forceServer ? await getServerFirst(q) : await q.get();
        if(snap.empty){
          if (tableEl.children.length === 0) emptyList.classList.remove('hidden');
          return;
        }
        emptyList.classList.add('hidden');
        lastDoc = snap.docs[snap.docs.length-1];
        let subtotal = 0;
        snap.forEach(doc=>{
          const c = { id: doc.id, ...doc.data() };
          subtotal += Number(c.totalAmount||0);
          tableEl.appendChild(rowTplList(c));
        });
        const cur = Number(listTotalEl.textContent || 0);
        listTotalEl.textContent = String(cur + subtotal);
      }
      document.getElementById('btnQuery').addEventListener('click', ()=> runQuery(true, true));
      document.getElementById('btnShowAll').addEventListener('click', ()=>{ document.getElementById('q').value=''; document.getElementById('filterOwner').value=''; runQuery(true, true); });
      document.getElementById('btnLoadMore').addEventListener('click', ()=> runQuery(false, true));

      
// 直接改選「誰的客戶」就查
document.getElementById('filterOwner').addEventListener('change', ()=> runQuery(true, true));
// 在關鍵字輸入框按 Enter 也能查
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); runQuery(true, true); } });


      // Totals
      async function calcGrandTotal(){
        const idPath = firebase.firestore.FieldPath.documentId();
        let last=null, more=true, sum=0;
        try{
          while(more){
            let q = db.collection('clients').orderBy(idPath).limit(400);
            if(last) q = q.startAfter(last);
            const snap = await getServerFirst(q);
            if(snap.empty){ more=false; break; }
            snap.forEach(doc=>{ const v=Number(doc.data()?.totalAmount||0); if(!isNaN(v)) sum+=v; });
            last = snap.docs[snap.docs.length-1];
            more = snap.docs.length===400;
          }
          const el = document.getElementById('grandTotal'); if(el) el.textContent = '$'+Number(sum).toLocaleString('zh-TW');
        }catch(e){ console.error(e); }
      }

      // ===== Tools: wipe collections =====
      async function wipeClients(){
        const input = prompt('⚠️ 這會刪除所有「客戶＋成交」資料，輸入 DELETE 以確認：');
        if(input!=='DELETE') return;
        const log = (m)=>{ const el=$('#wipeLog'); el.textContent += m + '\n'; el.scrollTop = el.scrollHeight; };
        log('開始清除 clients…');
        try{
          let last=null, more=true, count=0;
          while(more){
            let q = db.collection('clients').orderBy(firebase.firestore.FieldPath.documentId()).limit(50);
            if(last) q = q.startAfter(last);
            const snap = await getServerFirst(q);
            if(snap.empty){ more=false; break; }
            last = snap.docs[snap.docs.length-1];
            for (const doc of snap.docs){
              // 刪子集合 deals（分塊刪）
              let dlast=null, dmore=true;
              while(dmore){
                let dq = doc.ref.collection('deals').orderBy(firebase.firestore.FieldPath.documentId()).limit(400);
                if(dlast) dq = dq.startAfter(dlast);
                const ds = await dq.get();
                if(ds.empty){ dmore=false; break; }
                const batch = db.batch();
                ds.forEach(dd => batch.delete(dd.ref));
                await batch.commit();
                dlast = ds.docs[ds.docs.length-1];
                dmore = ds.docs.length===400;
              }
              await doc.ref.delete();
              count++;
              log('已刪客戶：'+(doc.data().name||doc.id));
            }
          }
          log('完成，總計刪除客戶數：'+count);
          toast('已清空客戶與成交');
          await runQuery(true, true);
          await calcGrandTotal();
        }catch(e){ console.error(e); toast('清空失敗'); log('發生錯誤：'+e.message); }
      }
      async function wipeMembers(){
        const input = prompt('⚠️ 這會刪除所有「成員」資料，輸入 DELETE 以確認：');
        if(input!=='DELETE') return;
        const log = (m)=>{ const el=$('#wipeLog'); el.textContent += m + '\n'; el.scrollTop = el.scrollHeight; };
        log('開始清除 members…');
        try{
          let last=null, more=true, count=0;
          while(more){
            let q = db.collection('members').orderBy(firebase.firestore.FieldPath.documentId()).limit(400);
            if(last) q = q.startAfter(last);
            const snap = await getServerFirst(q);
            if(snap.empty){ more=false; break; }
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            last = snap.docs[snap.docs.length-1];
            count += snap.size;
          }
          log('完成，總計刪除成員數：'+count);
          toast('已清空成員');
        }catch(e){ console.error(e); toast('清空失敗'); log('發生錯誤：'+e.message); }
      }
      document.getElementById('btnWipeClients').addEventListener('click', wipeClients);
      document.getElementById('btnWipeMembers').addEventListener('click', wipeMembers);

      // Boot
      window.addEventListener('load', async ()=>{
        try{ await mountMembersListener(); }catch(_){}
        try{ await runQuery(true, true); }catch(_){}
        try{ await calcGrandTotal(); }catch(_){}
      });

    }catch(err){
      console.error('main failed', err);
      document.getElementById('alertBar').classList.add('show');
    }
  })();
  </script>
</body>
</html>
